<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Console as a SQL interface for quick text file processing | Dedication</title>
  <meta name="author" content="Ronnie Wang">
  
  <meta name="description" content="Yet another tech blog!">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Console as a SQL interface for quick text file processing"/>
  <meta property="og:site_name" content="Dedication"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Dedication" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/paper.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-53608123-1', 'auto');
  ga('send', 'pageview');
</script>




</head>

 <body>
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Dedication</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/links" title="Friend links.">
			  <i class="fa fa-link"></i>Links
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header ">		
			<h1 class="title "> Console as a SQL interface for quick text file processing</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>最近在处理业务上的某些事情时，会发现这样的问题:为了调试某个程序，会 dump 出一堆中间文件的 log，去查找哪些地方发生了异常。这种文件都是 tsv 文件，即使用 TAB 分割的列表文件。一种最简单的做法就是在文本编辑器中打开这些文件，然后通过观察去查看异常，可以配合编辑器的搜索功能。在这方面 sublime text 最为适合，因为只有这个能打开大文件。但是，这样每一次打开都需要很长的时间，而且我去搜索某个字符串的时候，每输入一个字符编辑器就会停顿很长时间。</p>
<p>于是我希望能有这么一种东西，对文本文件这种没有被某种结构化工具存储的、没有明确定义 schema 的东西进行快速的查找、计算。简单地借用 SQL 中的术语，我希望能在不导入数据的情况下进行 <code>SELECT</code>、 <code>WHERE</code>、 <code>ORDER</code>、 <code>LIMIT</code>、 <code>JOIN</code> 等基本功能。幸运的是，最近发现了以前打印出来一直都没看的讲义，一些最基本的 Unix command 就基本上涵盖了我所希望的对文本文件处理的功能。本文就按照这些 SQL 功能语句把这些命令进行梳理。</p>
<p>本文进行处理的数据对象是在 2 月用 <a href="https://github.com/wattlebird/Bangumi_Spider" target="_blank" rel="external">Bangumi_Spider</a> 爬取的 Bangumi Data，这包括用户、条目和收藏记录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">head user-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">17</span>T12_26_12-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">19</span>T06_06_44.tsv -n <span class="number">5</span></span><br><span class="line">head record-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">20</span>T14_03_27-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">24</span>T10_57_16.tsv -n <span class="number">5</span></span><br><span class="line">head subject-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">26</span>T00_28_51-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">27</span>T02_15_34.tsv -n <span class="number">5</span></span><br></pre></td></tr></table></figure>
<pre><code><span class="tag">uid</span>    <span class="tag">name</span>    <span class="tag">nickname</span>    <span class="tag">joindate</span>    <span class="tag">activedate</span>
7    7    <span class="tag">lorien</span>.    2008<span class="tag">-07-14</span>    2010<span class="tag">-06-05</span>
2    2    陈永仁    2008<span class="tag">-07-14</span>    2017<span class="tag">-02-17</span>
8    8    堂堂    2008<span class="tag">-07-14</span>    2008<span class="tag">-07-14</span>
9    9    <span class="tag">lxl711</span>    2008<span class="tag">-07-14</span>    2008<span class="tag">-07-14</span>
<span class="tag">name</span>    <span class="tag">iid</span>    <span class="tag">typ</span>    <span class="tag">state</span>    <span class="tag">adddate</span>    <span class="tag">rate</span>    <span class="tag">tags</span>
2    189708    <span class="tag">real</span>    <span class="tag">dropped</span>    2016<span class="tag">-10-06</span>        
2    76371    <span class="tag">real</span>    <span class="tag">dropped</span>    2015<span class="tag">-11-07</span>        
2    119224    <span class="tag">real</span>    <span class="tag">dropped</span>    2015<span class="tag">-03-04</span>        
2    100734    <span class="tag">real</span>    <span class="tag">dropped</span>    2014<span class="tag">-10-09</span>        
<span class="tag">subjectid</span>    <span class="tag">authenticid</span>    <span class="tag">subjectname</span>    <span class="tag">subjecttype</span>    <span class="tag">rank</span>    <span class="tag">date</span>    <span class="tag">votenum</span>    <span class="tag">favnum</span>    <span class="tag">tags</span>
1    1    第一次的親密接觸    <span class="tag">book</span>    1069    1999<span class="tag">-11-01</span>    57    <span class="attr_selector">[7, 84, 0, 3, 2]</span>    小説<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">NN</span>:<span class="value"><span class="number">1</span></span></span>;1999<span class="pseudo">:1</span>;国<span class="pseudo">:1</span>;台湾<span class="pseudo">:4</span>;网络<span class="pseudo">:2</span>;三次元<span class="pseudo">:5</span>;轻舞飞扬<span class="pseudo">:9</span>;国产<span class="pseudo">:2</span>;爱情<span class="pseudo">:9</span>;经典<span class="pseudo">:5</span>;少女系<span class="pseudo">:1</span>;蔡智恒<span class="pseudo">:8</span>;小说<span class="pseudo">:5</span>;痞子蔡<span class="pseudo">:20</span>;书籍<span class="pseudo">:1</span>
2    2    坟场    <span class="tag">music</span>    272        421    <span class="attr_selector">[108, 538, 50, 18, 20]</span>    陈老师<span class="pseudo">:1</span>;银魂<span class="pseudo">:1</span>;冷泉夜月<span class="pseudo">:1</span>;中配<span class="pseudo">:1</span>;银魂中配<span class="pseudo">:1</span>;治愈系<span class="pseudo">:1</span>;银他妈<span class="pseudo">:1</span>;神还原<span class="pseudo">:1</span>;恶搞<span class="pseudo">:1</span>;陈绮贞<span class="pseudo">:9</span>
4    4    合金弹头7    <span class="tag">game</span>    2396    2008<span class="tag">-07-17</span>    120    <span class="attr_selector">[14, 164, 6, 3, 2]</span>    <span class="rule"><span class="attribute">STG</span>:<span class="value"><span class="number">1</span></span></span>;结束<span class="pseudo">:1</span>;暴力<span class="pseudo">:1</span>;动作<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">SNK</span>:<span class="value"><span class="number">10</span></span></span>;汉化<span class="pseudo">:1</span>;2008<span class="pseudo">:1</span>;六星<span class="pseudo">:1</span>;合金弹头<span class="pseudo">:26</span>;<span class="rule"><span class="attribute">ACT</span>:<span class="value"><span class="number">10</span></span></span>;<span class="rule"><span class="attribute">NDS</span>:<span class="value"><span class="number">38</span></span></span>;<span class="tag">Metal_Slug_7</span><span class="pseudo">:6</span>;诚意不足<span class="pseudo">:2</span>;移植<span class="pseudo">:2</span>
6    6    军团要塞2    <span class="tag">game</span>    895    2007<span class="tag">-10-10</span>    107    <span class="attr_selector">[15, 108, 23, 9, 7]</span>    抓好社会主义精神文明建设<span class="pseudo">:3</span>;团队要塞<span class="pseudo">:3</span>;帽子<span class="pseudo">:5</span>;出门杀<span class="pseudo">:1</span>;半条命2<span class="pseudo">:5</span>;<span class="rule"><span class="attribute">Valve</span>:<span class="value"><span class="number">31</span></span></span>;<span class="rule"><span class="attribute">PC</span>:<span class="value"><span class="number">13</span></span></span>;军团要塞<span class="pseudo">:7</span>;军团要塞2<span class="pseudo">:24</span>;<span class="rule"><span class="attribute">FPS</span>:<span class="value"><span class="number">26</span></span></span>;经典<span class="pseudo">:6</span>;<span class="rule"><span class="attribute">tf</span>:<span class="value"><span class="number">1</span></span></span>;枪枪枪<span class="pseudo">:4</span>;2007<span class="pseudo">:2</span>;<span class="rule"><span class="attribute">STEAM</span>:<span class="value"><span class="number">25</span></span></span>;<span class="tag">TF2</span><span class="pseudo">:15</span>
</code></pre><p>由于爬虫的性质，这些数据有以下缺陷：</p>
<ol>
<li>非实时。我所说的“实时”并不是今天是 4 月 16 日而数据只是 2 月的，而是我无法保证数据是在某一个时间点上的快照。对于用户数据，由于爬取一次需要两天的时间，在这两天的时间里，可能用户修改了他们的昵称和用户名而在爬取的数据上未反映出来。更为严重的问题是，对于收藏数据，可能会出现在爬取数据的时候用户进行了收藏的操作，导致爬取的数据出现重复或缺失。而且由于用户数据和收藏数据是分开爬取的，我无法保证通过用户名能把两个 table 一一对应地 join 起来。</li>
<li>非顺序。可以从预览的数据中看到。</li>
<li>爬虫本身缺陷。由于我对于 Bangumi 出现 500 错误没有在处理上体现出来，所以会导致某些数据有所缺失。</li>
</ol>
<p>在下面的文章里，我们将一边使用 Unix Command 对数据进行类似于 SQL 语句的操作，一边阐述 Bangumi_Spider 产生的 data 的各种特点和后续处理需要注意的问题。</p>
<h2 id="1-_SELECT_…_WHERE_…_ORDER_BY_…">1. SELECT … WHERE … ORDER BY …</h2><h3 id="筛选_2017_冬季番组">筛选 2017 冬季番组</h3><p>现在我们有了条目数据， 而条目数据是记录了标签信息的，我们可以从标签信息中抽取出 2017 年冬季番组。这个标签是“2017 年 1 月”。我们可以用一个 grep 语句取出这些番组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">"2017年1月"</span> subject-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">26</span>T00_28_51-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">27</span>T02_15_34.tsv | grep <span class="string">"anime"</span> | wc <span class="operator">-l</span></span><br></pre></td></tr></table></figure>
<pre><code>90
</code></pre><p>然而这个抽取方式有很大的缺陷。我们没有指定应该在数据的哪一列上查找“anime”或“2017 年 1 月”！如果有一部音乐条目的名字里面就有 anime 这个词，而又被打上了 2017 年 1 月的标签呢？这显然不是我们希望得到的。实际上，需要指定列的话，最好的方式就是使用 <code>awk</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">"\t"</span> <span class="string">'$9 ~ /[;\t]2017年1月:/ &amp;&amp; $4=="anime"'</span> subject-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">26</span>T00_28_51-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">27</span>T02_15_34.tsv &gt; anime_selection.tsv</span><br><span class="line">wc <span class="operator">-l</span> anime_selection.tsv</span><br><span class="line">head anime_selection.tsv -n <span class="number">5</span></span><br></pre></td></tr></table></figure>
<pre><code>85 <span class="tag">anime_selection</span><span class="class">.tsv</span>
122772    122772    六心公主    <span class="tag">anime</span>        2016<span class="tag">-12-30</span>    26    <span class="attr_selector">[19, 41, 1, 1, 4]</span>    17冬<span class="pseudo">:1</span>;原创<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">PONCOTAN</span>:<span class="value"><span class="number">4</span></span></span>;2016年<span class="pseudo">:2</span>;广桥凉<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">TVSP</span>:<span class="value"><span class="number">1</span></span></span>;池赖宏<span class="pseudo">:1</span>;原优子<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">mebae</span>:<span class="value"><span class="number">1</span></span></span>;<span class="rule"><span class="attribute">TV</span>:<span class="value"><span class="number">4</span></span></span>;日本动画<span class="pseudo">:1</span>;片山慎三<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">Studio</span>:<span class="value"><span class="number">1</span></span></span>;<span class="rule"><span class="attribute">STUDIOPONCOTAN</span>:<span class="value"><span class="number">4</span></span></span>;2016<span class="pseudo">:5</span>;<span class="rule"><span class="attribute">TVA</span>:<span class="value"><span class="number">1</span></span></span>;短片<span class="pseudo">:2</span>;上田繁<span class="pseudo">:1</span>;搞笑<span class="pseudo">:4</span>;中川大地<span class="pseudo">:2</span>;岛津裕之<span class="pseudo">:2</span>;种崎敦美<span class="pseudo">:1</span>;2017年1月<span class="pseudo">:1</span>;テレビアニメ<span class="pseudo">:1</span>;オリジナル<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">SP</span>:<span class="value"><span class="number">1</span></span></span>;6<span class="rule"><span class="attribute">HP</span>:<span class="value"><span class="number">2</span></span></span>;村上隆<span class="pseudo">:10</span>;未确定<span class="pseudo">:1</span>
125900    125900    锁链战记～赫克瑟塔斯之光～    <span class="tag">anime</span>    3065    2017<span class="tag">-01-07</span>    88    <span class="attr_selector">[66, 24, 216, 20, 60]</span>    山下大辉<span class="pseudo">:3</span>;17冬<span class="pseudo">:1</span>;原创<span class="pseudo">:1</span>;游戏改<span class="pseudo">:47</span>;<span class="rule"><span class="attribute">CC</span>:<span class="value"><span class="number">1</span></span></span>;花泽香菜<span class="pseudo">:7</span>;<span class="rule"><span class="attribute">TV</span>:<span class="value"><span class="number">22</span></span></span>;未确定<span class="pseudo">:2</span>;グラフィニカ<span class="pseudo">:2</span>;佐仓绫音<span class="pseudo">:4</span>;2017年1月<span class="pseudo">:61</span>;锁链战记<span class="pseudo">:1</span>;2017<span class="pseudo">:10</span>;锁链战记～<span class="tag">Haecceitas</span>的闪光～<span class="pseudo">:15</span>;热血<span class="pseudo">:2</span>;チェインクロ<span class="pseudo">:1</span>;石田彰<span class="pseudo">:22</span>;声优<span class="pseudo">:2</span>;2017年<span class="pseudo">:4</span>;<span class="rule"><span class="attribute">Telecom_Animation_Film</span>:<span class="value"><span class="number">1</span></span></span>;十文字<span class="pseudo">:1</span>;柳田淳一<span class="pseudo">:1</span>;战斗<span class="pseudo">:2</span>;内田真礼<span class="pseudo">:2</span>;剧场版<span class="pseudo">:1</span>;奇幻<span class="pseudo">:17</span>;2017·01·07<span class="pseudo">:1</span>;工藤昌史<span class="pseudo">:3</span>;2015年10月<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">TelecomAnimationFilm</span>:<span class="value"><span class="number">9</span>
<span class="number">126185</span>    <span class="number">126185</span>    POPIN Q    anime        <span class="number">2016</span>-<span class="number">12</span>-<span class="number">23</span>    <span class="number">10</span>    [<span class="number">134</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>]    荒井修子:<span class="number">1</span></span></span>;黒星紅白<span class="pseudo">:4</span>;原创<span class="pseudo">:3</span>;黑星红白<span class="pseudo">:1</span>;2016年<span class="pseudo">:5</span>;<span class="rule"><span class="attribute">_Q</span>:<span class="value"><span class="number">1</span></span></span>;日本动画<span class="pseudo">:1</span>;2016年12月<span class="pseudo">:2</span>;未确定<span class="pseudo">:1</span>;小泽亚李<span class="pseudo">:1</span>;2017<span class="pseudo">:2</span>;2016<span class="pseudo">:5</span>;动画电影<span class="pseudo">:1</span>;2017年<span class="pseudo">:5</span>;<span class="rule"><span class="attribute">Q</span>:<span class="value"><span class="number">3</span></span></span>;东映动画<span class="pseudo">:1</span>;种崎敦美<span class="pseudo">:1</span>;2017年1月<span class="pseudo">:1</span>;宫原直树<span class="pseudo">:1</span>;<span class="rule"><span class="attribute">POPIN</span>:<span class="value"><span class="number">6</span></span></span>;東映アニメーション<span class="pseudo">:12</span>;剧场版<span class="pseudo">:24</span>;东映<span class="pseudo">:4</span>;萌系画风<span class="pseudo">:1</span>;濑户麻沙美<span class="pseudo">:5</span>
129805    129805    混沌子    <span class="tag">anime</span>    2910    2017<span class="tag">-01-11</span>    197    <span class="attr_selector">[264, 24, 764, 60, 67]</span>    上坂すみれ<span class="pseudo">:3</span>;ブリドカットセーラ恵美<span class="pseudo">:2</span>;季番<span class="pseudo">:2</span>;黑暗推理向慎入<span class="pseudo">:2</span>;2016年<span class="pseudo">:3</span>;<span class="rule"><span class="attribute">CHAOS</span>:<span class="value"><span class="number">5</span></span></span>;游戏改<span class="pseudo">:67</span>;<span class="rule"><span class="attribute">SILVER_LINK.</span>:<span class="value"><span class="number">2</span></span></span>;悬疑<span class="pseudo">:5</span>;游戏<span class="pseudo">:9</span>;<span class="rule"><span class="attribute">TV</span>:<span class="value"><span class="number">73</span></span></span>;未确定<span class="pseudo">:9</span>;伪<span class="pseudo">:4</span>;<span class="tag">GAL</span>改<span class="pseudo">:106</span>;2017<span class="pseudo">:28</span>;科幻<span class="pseudo">:2</span>;志倉千代丸<span class="pseudo">:4</span>;<span class="rule"><span class="attribute">SILVERLINK.</span>:<span class="value"><span class="number">34</span></span></span>;<span class="rule"><span class="attribute">SLIVERLINK.</span>:<span class="value"><span class="number">70</span></span></span>;2017年<span class="pseudo">:10</span>;志仓千代丸<span class="pseudo">:4</span>;2017年1月<span class="pseudo">:170</span>;5<span class="rule"><span class="attribute">pb.</span>:<span class="value"><span class="number">112</span></span></span>;混沌子<span class="pseudo">:3</span>;反乌托邦<span class="pseudo">:16</span>;剧透禁止<span class="pseudo">:27</span>;极权主义世界<span class="pseudo">:8</span>;松冈祯丞<span class="pseudo">:3</span>;神保昌登<span class="pseudo">:6</span>;<span class="rule"><span class="attribute">CHILD</span>:<span class="value"><span class="number">5</span>
<span class="number">131901</span>    <span class="number">131901</span>    神怒之日    anime        <span class="number">2017</span>-<span class="number">10</span>-<span class="number">01</span>    <span class="number">0</span>    [<span class="number">79</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>]    GENCO:<span class="number">3</span></span></span>;2017年10月<span class="pseudo">:2</span>;<span class="rule"><span class="attribute">TV</span>:<span class="value"><span class="number">4</span></span></span>;未确定<span class="pseudo">:2</span>;2017年<span class="pseudo">:2</span>;<span class="tag">GAL</span>改<span class="pseudo">:4</span>;游戏改<span class="pseudo">:4</span>;<span class="rule"><span class="attribute">LIGHT</span>:<span class="value"><span class="number">2</span></span></span>;2017<span class="pseudo">:3</span>;エロゲ改<span class="pseudo">:3</span>;2017年1月<span class="pseudo">:1</span>
</code></pre><p>可以看到，我们提升了一些 precision。<code>awk</code> 的思想就是把一个文本文件按行处理，然后在单引号里面对行进行编程。你可以看到，我们使用内部变量 \$9 指定第 9 列的内容（你可以看到，是从 1 开始标号的），这一列是标签。我们使用正则表达式对 \$9 进行匹配，正则表达式需要用斜杠包围。同时，我们指定第四列的内容是 anime。这样就可以将满足我们需求的条目筛选出来。顺便说一句，\$0 是整行的内容。</p>
<h3 id="按照在看人数排序">按照在看人数排序</h3><p>我们在条目中用一个数组记录了想看、看过、在看、搁置和抛弃的人数。这个数组用方括号所包围。我现在希望对我刚才抽取的冬季番组按照在看人数从大到小排序。这需要我们抽取出第八列，然后从该列中抽取出在看人数。使用以下命令可以达到我的目的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">"\t"</span> <span class="string">'&#123;match($8, /\[([0-9]+), ([0-9]+), ([0-9]+), ([0-9]+), ([0-9]+)\]/, m); printf("%d\t%s\t%s\t%d\t%d\t%d\t%d\t%d\n", $1, $3, $4, m[1], m[2], m[3], m[4], m[5])&#125;'</span> &lt; anime_selection.tsv | sort -t$<span class="string">'\t'</span> -k6,<span class="number">6</span> -nr | sed <span class="number">5</span>q</span><br></pre></td></tr></table></figure>
<pre><code>179949    小林家的龙女仆    anime    157    84    2065    19    46
185792    小魔女学园    anime    245    51    1471    30    29
174043    为美好的世界献上祝福！ 第二季    anime    297    63    1431    21    28
174143    人渣的本愿    anime    271    51    1381    60    133
188091    珈百璃的堕落    anime    126    46    1366    22    73
</code></pre><p>按照管道切割，第一个语句还是使用 <code>awk</code>，但是执行的功能不是筛选，而是构造新表。在这个构造新表的过程中，观看人数的抽取使用了 <code>match</code> 函数。被抽取的对象存储在变量 <code>m</code> 里，是 <code>match</code> 的第三个变量。第一个变量是目标匹配字符串，第二个变量是正则表达式。注意需要将匹配的对象用圆括号括起来。</p>
<p>awk 的函数有很多，具体的可以直接参考 <a href="https://www.gnu.org/software/gawk/manual/gawk.html" target="_blank" rel="external">awk 手册</a>（我估计没人会看的）或是<a href="https://www.math.utah.edu/docs/info/gawk_13.html" target="_blank" rel="external">这里</a>。很多都是 C 语言的内置函数。</p>
<p>对于排序功能我们需要调用 <code>sort</code> 命令。首先需要指定输入文件的分隔符（注意这里有点 hacky，必须是 <code>-t$&#39;\t&#39;</code>）。由于我们希望对在看人数从大到小排序，我们必须指定按照第 6 列排序，即 <code>-k6,6</code>。同时我们指定 <code>-nr</code> 表明视第六列为数字并倒序。</p>
<p>结果显示了在二月某个时刻收看番组的前五个。Very reasonable。</p>
<h3 id="抽取标签列表">抽取标签列表</h3><p>既然我们已经爬取了标签，能不能对爬取的标签列表进行展开？这时候要使用 <code>awk</code> 的 <code>split</code> 函数和 array 类型了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">"\t"</span> <span class="string">'&#123;split($9, tags, ";");for(i in tags)&#123; split(tags[i], itm, ":"); printf("%d\t%s\t%s\t%d\n", $1, $3, itm[1], itm[2]);&#125;;&#125;'</span> &lt; anime_selection.tsv | sort -t$<span class="string">'\t'</span> -k1,<span class="number">1</span>n -k4,<span class="number">4</span>nr | head -n <span class="number">20</span></span><br></pre></td></tr></table></figure>
<pre><code><span class="number">122772</span>    六心公主    村上隆    <span class="number">10</span>
<span class="number">122772</span>    六心公主    <span class="number">2016</span>    <span class="number">5</span>
<span class="number">122772</span>    六心公主    PONCOTAN    <span class="number">4</span>
<span class="number">122772</span>    六心公主    STUDIOPONCOTAN    <span class="number">4</span>
<span class="number">122772</span>    六心公主    TV    <span class="number">4</span>
<span class="number">122772</span>    六心公主    搞笑    <span class="number">4</span>
<span class="number">122772</span>    六心公主    <span class="number">2016</span>年    <span class="number">2</span>
<span class="number">122772</span>    六心公主    <span class="number">6</span>HP    <span class="number">2</span>
<span class="number">122772</span>    六心公主    中川大地    <span class="number">2</span>
<span class="number">122772</span>    六心公主    岛津裕之    <span class="number">2</span>
<span class="number">122772</span>    六心公主    短片    <span class="number">2</span>
<span class="number">122772</span>    六心公主    テレビアニメ    <span class="number">1</span>
<span class="number">122772</span>    六心公主    オリジナル    <span class="number">1</span>
<span class="number">122772</span>    六心公主    <span class="number">17</span>冬    <span class="number">1</span>
<span class="number">122772</span>    六心公主    <span class="number">2017</span>年<span class="number">1</span>月    <span class="number">1</span>
<span class="number">122772</span>    六心公主    mebae    <span class="number">1</span>
<span class="number">122772</span>    六心公主    SP    <span class="number">1</span>
<span class="number">122772</span>    六心公主    Studio    <span class="number">1</span>
<span class="number">122772</span>    六心公主    TVA    <span class="number">1</span>
<span class="number">122772</span>    六心公主    TVSP    <span class="number">1</span>
<span class="keyword">sort</span>: <span class="keyword">write</span> failed: standard output: Broken <span class="keyword">pipe</span>
<span class="keyword">sort</span>: <span class="keyword">write</span> error
</code></pre><p>由于标签列表是按照分号分隔的，我们首先使用 <code>split($9, tags, &quot;;&quot;)</code> 把分割后的字符串存储在 array <code>tags</code> 里。接着在 <code>for(i in tags)</code> 里，<code>i</code> 实际上是 index，对于每一个 tag 我们再次使用 <code>split</code>，得到具体的 tag 和 tag 人数。可以看到，可以使用 C 语言的方式写 awk 的行处理逻辑。在写的时候是可以隔行的，虽然我都写在了一行。</p>
<p>在此之后，我们首先对条目的 id 排序，再在条目中对 tag 的标记人数排序。这里 <code>sort</code> 需要使用两个 <code>-k</code> 选项指定排序顺序。同时我们把 <code>-nr</code> 的条件写在每个排序列的后面，这样可以对列按照不同的排序逻辑排序。</p>
<h2 id="2-_Aggregation">2. Aggregation</h2><h3 id="计数">计数</h3><p>我们更为关心的是收藏数据中的一些统计数据，如平均分、活跃人数等。最基本的统计数据形式就是计数。虽然可以使用 awk 完成，但是这个比较特殊，有更为简单的方法。</p>
<p>比如说，我们想在上文抽取出来的冬季番组标签中统计每个番组会有多少标签。鉴于我们已经把标签对每个动画展开了，我们就可以对每个动画出现的次数进行统计，就可以得到该动画对应的标签数量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cut <span class="operator">-f</span>1,<span class="number">2</span> &lt; anime_taglist.tsv| uniq -c | sed <span class="number">10</span>q</span><br></pre></td></tr></table></figure>
<pre><code>29 122772    六心公主
30 125900    锁链战记～赫克瑟塔斯之光～
25 126185    POPIN <span class="literal">Q</span>
30 129805    混沌子
11 131901    神怒之日
30 143205    南镰仓高校女子自行车社
29 146732    碧蓝幻想
30 148037    伤物语III 冷血篇
30 148099    刀剑神域：序列之争
30 148181    飙速宅男 新世代
</code></pre><p>其中，<code>cut</code> 命令对我们抽取出来的标签列表的第一列和第二列单独取出，然后送给 <code>uniq</code>。 <code>uniq</code> 会对每行进行 de-duplication 的操作，并且加上 <code>-c</code> 的选项会给出每行出现的个数。在输出的内容中，第一列就是每个动画对应的标签数量。</p>
<p><strong>需要重点强调的是，uniq 只能对已经排序的输入有效。</strong></p>
<p>可以看到，在一个条目页面，标签数量最多只有 30 个。</p>
<h3 id="最大、最小值">最大、最小值</h3><p>有时候我们会对列表的某几项求取最大、最小值。下面显示了如何求取每一部动画标记人数最多的 tag。当然，我们也是用 <code>awk</code> 完成的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">"\t"</span> <span class="string">'$1!=prev &#123;print $0; prev=$1&#125;'</span> &lt;anime_taglist.tsv | sed <span class="number">10</span>q</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">122772</span>    六心公主    村上隆    <span class="number">10</span>
<span class="number">125900</span>    锁链战记～赫克瑟塔斯之光～    <span class="number">2017</span>年<span class="number">1</span>月    <span class="number">61</span>
<span class="number">126185</span>    POPIN Q    剧场版    <span class="number">24</span>
<span class="number">129805</span>    混沌子    <span class="number">2017</span>年<span class="number">1</span>月    <span class="number">170</span>
<span class="number">131901</span>    神怒之日    GAL改    <span class="number">4</span>
<span class="number">143205</span>    南镰仓高校女子自行车社    <span class="number">2017</span>年<span class="number">1</span>月    <span class="number">34</span>
<span class="number">146732</span>    碧蓝幻想    <span class="literal">A</span>-<span class="number">1</span>Pictures    <span class="number">38</span>
<span class="number">148037</span>    伤物语III 冷血篇    剧场版    <span class="number">80</span>
<span class="number">148099</span>    刀剑神域：序列之争    剧场版    <span class="number">87</span>
<span class="number">148181</span>    飙速宅男 新世代    <span class="number">2017</span>年<span class="number">1</span>月    <span class="number">36</span>
</code></pre><p>请注意，受了 <code>uniq</code> 的启发，这里的处理也是需要输入已经排好序。</p>
<h3 id="平均值">平均值</h3><p>既然有了 <code>awk</code>，我们就可以做更多的复杂计算。这里我们用平均值举一个例子：我们希望对爬取的收藏记录挑出动画和有评分的，计算其平均值。我还是希望能在有序输入上计算，于是先生成有序输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="number">1</span>d record-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">20</span>T14_03_27-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">24</span>T10_57_16.tsv | awk -F <span class="string">"\t"</span> <span class="string">'$6 &amp;&amp; $3=="anime"'</span> | sort -k2,<span class="number">2</span>n | cut <span class="operator">-f</span>7 --complement &gt; anime_record.tsv</span><br><span class="line">head anime_record.tsv</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">103122</span>    <span class="number">2</span>    anime    <span class="keyword">do</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">18</span>    <span class="number">9</span>
<span class="number">103909</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">11</span>-<span class="number">06</span>    <span class="number">8</span>
<span class="number">104394</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">12</span>-<span class="number">28</span>    <span class="number">9</span>
<span class="number">110320</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">12</span>-<span class="number">11</span>    <span class="number">10</span>
<span class="number">112414</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">12</span>-<span class="number">26</span>    <span class="number">7</span>
<span class="number">118090</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2013</span>-<span class="number">01</span>-<span class="number">31</span>    <span class="number">7</span>
<span class="number">125406</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2013</span>-<span class="number">03</span>-<span class="number">04</span>    <span class="number">8</span>
<span class="number">165363</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2013</span>-<span class="number">10</span>-<span class="number">10</span>    <span class="number">6</span>
<span class="number">183190</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2014</span>-<span class="number">02</span>-<span class="number">01</span>    <span class="number">8</span>
<span class="number">207963</span>    <span class="number">2</span>    anime    <span class="keyword">collect</span>    <span class="number">2014</span>-<span class="number">07</span>-<span class="number">21</span>    <span class="number">8</span>
</code></pre><p>然后按照下式计算每个动画的平均值，并把平均值从高到低排序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">"\t"</span> <span class="string">'&#123;cnt[$2]+=1; cum[$2]+=$6&#125;; END &#123;for(i in cnt)&#123;printf("%d\t%f\t%d\n", i, cum[i]/cnt[i], cnt[i]);&#125;&#125;'</span> &lt; anime_record.tsv | sort -t$<span class="string">'\t'</span> -k2,<span class="number">2</span>nr -k3,<span class="number">3</span>nr | head</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">202419</span>    <span class="number">10.000000</span>    <span class="number">4</span>
<span class="number">186960</span>    <span class="number">10.000000</span>    <span class="number">3</span>
<span class="number">143694</span>    <span class="number">10.000000</span>    <span class="number">2</span>
<span class="number">158396</span>    <span class="number">10.000000</span>    <span class="number">2</span>
<span class="number">193619</span>    <span class="number">10.000000</span>    <span class="number">2</span>
<span class="number">11121</span>    <span class="number">10.000000</span>    <span class="number">1</span>
<span class="number">127124</span>    <span class="number">10.000000</span>    <span class="number">1</span>
<span class="number">127125</span>    <span class="number">10.000000</span>    <span class="number">1</span>
<span class="number">127597</span>    <span class="number">10.000000</span>    <span class="number">1</span>
<span class="number">137405</span>    <span class="number">10.000000</span>    <span class="number">1</span>
<span class="keyword">sort</span>: <span class="keyword">write</span> failed: standard output: Broken <span class="keyword">pipe</span>
<span class="keyword">sort</span>: <span class="keyword">write</span> error
</code></pre><p>需要注意的是，这里又使用了 <code>awk</code> 里面的字典数据结构（associative array）。你可以看作是一个 python 里面的 <code>dict</code>。我们使用了两个变量：<code>cnt</code> 和 <code>cum</code> 存储每一个动画 id 的评分人数和评分总和。在最后，我们在 <code>END</code> 包围的代码块里面生成最后的结果。这时候 <code>END</code> 里面的语句是在文件遍历之后执行的。</p>
<h2 id="3-_Union,_intersection_and_except">3. Union, intersection and except</h2><h3 id="在用户记录中丢失的用户">在用户记录中丢失的用户</h3><p>在前文我们讲过，用户数据可能会因爬虫爬取时出现 500 错误而丢失，但是条目记录可能保留了这部分数据。而且，由于用户数据爬取的时间先于收藏数据，会出现用户在其间改了用户名、还有新的注册用户加入 Bangumi 等问题。这里我们试着查看有多少这类在用户数据中丢失的用户。</p>
<p>首先我们用用户数据生成用户 id 和 username 的列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="number">1</span>d user-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">17</span>T12_26_12-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">19</span>T06_06_44.tsv| cut <span class="operator">-f</span>1,<span class="number">2</span> | sort -t$<span class="string">'\t'</span> -k1,<span class="number">1</span>n &gt; user_list.tsv</span><br><span class="line">tail user_list.tsv</span><br></pre></td></tr></table></figure>
<pre><code>321167    321167
321168    321168
321169    321169
321170    321170
321171    321171
321172    321172
321173    321173
321174    321174
321175    321175
321176    321176
</code></pre><p>还有条目数据中的用户列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="number">1</span>d record-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">20</span>T14_03_27-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">24</span>T10_57_16.tsv | cut <span class="operator">-f</span>1 | sort -t$<span class="string">'\t'</span> -k1,<span class="number">1</span> | uniq &gt; record_user.tsv</span><br><span class="line">head record_user.tsv</span><br></pre></td></tr></table></figure>
<pre><code>100004
100017
100018
100026
100039
100049
100051
100054
10006
100060
</code></pre><p>这实际上就是求 record_user 对于 user_list 中 user 的差集。如果是这样的话，我们可以使用 <code>comm</code> 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cut <span class="operator">-f</span>2 user_list.tsv| sort | comm -<span class="number">13</span> - record_user.tsv &gt; user_failure.tsv</span><br><span class="line">head user_failure.tsv</span><br></pre></td></tr></table></figure>
<pre><code>12372
128259
1465
15000
174374
17601
210506
223507
257848
273783
</code></pre><p><code>comm</code> 命令对每个文件的行操作，同时它的先验要求是文件已经排过序。它可以给出三列数据：仅在第一个文件中出现的行；仅在第二个文件中出现的行；在两个文件中同时出现的行。可以看出，这个就是求差集和并集的操作。通过指定 <code>-13</code>,我们指定只输出仅在第二个文件中出现的行，也就是在 user_list.tsv 中没有爬到的用户。</p>
<h2 id="4-_Join">4. Join</h2><h3 id="获得收藏数据中的用户_id">获得收藏数据中的用户 id</h3><p>在收藏数据中，我们记录下了用户的用户名，却没有记录用户 id 和用户昵称！这个是爬虫在设计时候的缺陷。这时候只能通过和用户数据 join 来弥补了。可是怎么在文本文件中进行 join 的操作呢？</p>
<p>首先，我们抽取两组数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="number">1</span>d record-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">20</span>T14_03_27-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">24</span>T10_57_16.tsv| sort -t$<span class="string">'\t'</span> -k1,<span class="number">1</span> &gt; record.sorted.tsv</span><br><span class="line">head record.sorted.tsv</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">100004</span>    <span class="number">10380</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">09</span>-<span class="number">30</span>    <span class="number">10</span>    标签:;中二病;花泽香菜;嘟嘟噜;牧瀬紅莉栖;Steins
<span class="number">100004</span>    <span class="number">10440</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">9</span>    标签:;あの日見た花の名前を僕達はまだ知らない
<span class="number">100004</span>    <span class="number">10639</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>        标签:;虚渊玄;奈绪蘑菇;梶浦
<span class="number">100004</span>    <span class="number">16235</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">8</span>    标签:;未来日记;我妻由乃
<span class="number">100004</span>    <span class="number">18635</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">7</span>    标签:;罪恶王冠;泽野弘之
<span class="number">100004</span>    <span class="number">23684</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">09</span>-<span class="number">30</span>    <span class="number">9</span>    标签:;黑子的篮球;基
<span class="number">100004</span>    <span class="number">23686</span>    anime    <span class="keyword">do</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">01</span>        标签:;刀剑神域;<span class="number">2012</span>年<span class="number">7</span>月;SAO;川原砾;梶浦由纪
<span class="number">100004</span>    <span class="number">2453</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">7</span>    标签:;BRS;Black★RockShooter
<span class="number">100004</span>    <span class="number">2463</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">8</span>    标签:;デュラララ!!
<span class="number">100004</span>    <span class="number">265</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">09</span>-<span class="number">30</span>    <span class="number">10</span>    标签:;EVA;庵野秀明;神作;Evangelion;补完
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="number">1</span>d user-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">17</span>T12_26_12-<span class="number">2017</span>-<span class="number">02</span>-<span class="number">19</span>T06_06_44.tsv| cut <span class="operator">-f</span>1,<span class="number">2</span>,<span class="number">3</span> | sort -t$<span class="string">'\t'</span> -k2,<span class="number">2</span> &gt; user_list.sorted.tsv</span><br><span class="line">head user_list.sorted.tsv</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">10</span>    <span class="number">10</span>    ＭｏＭｏ.
<span class="number">100</span>    <span class="number">100</span>    <span class="variable">Jacob</span>
<span class="number">10000</span>    <span class="number">10000</span>    漠漠
<span class="number">100000</span>    <span class="number">100000</span>    natalie_1204
<span class="number">100001</span>    <span class="number">100001</span>    七堂伽蓝
<span class="number">100002</span>    <span class="number">100002</span>    宇
<span class="number">100003</span>    <span class="number">100003</span>    二的二次方
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的<span class="variable">K</span>
<span class="number">100005</span>    <span class="number">100005</span>    <span class="variable">Astrid</span>
<span class="number">100006</span>    <span class="number">100006</span>    tsiaben
</code></pre><p>需要注意的是，我们希望对用户的用户名进行 join，其前提是我们的列表需要对被 join 的列进行排序。我们已经在上面进行了对用户名列的排序操作。</p>
<p>接着，我们可以使用 <code>join</code> 了。我们可以首先进行 INNER JOIN：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># inner join</span></span><br><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> user_list.sorted.tsv record.sorted.tsv | wc <span class="operator">-l</span></span><br></pre></td></tr></table></figure>
<pre><code>6483106
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> user_list.sorted.tsv record.sorted.tsv | sed <span class="number">5</span>q</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">10380</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">09</span>-<span class="number">30</span>    <span class="number">10</span>    标签:;中二病;花泽香菜;嘟嘟噜;牧瀬紅莉栖;Steins
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">10440</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">9</span>    标签:;あの日見た花の名前を僕達はまだ知らない
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">10639</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>        标签:;虚渊玄;奈绪蘑菇;梶浦
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">16235</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">8</span>    标签:;未来日记;我妻由乃
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">18635</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">7</span>    标签:;罪恶王冠;泽野弘之
<span class="keyword">join</span>: <span class="keyword">write</span> error: Broken pipe
</code></pre><p>可以看到我们已经 join 了一些有价值的东西。被 join 的那个字段总是在第一列。</p>
<p>如果使用 LEFT OUTER JOIN 或是 RIGHT OUTER JOIN，我们需要用 <code>-a</code> 指定哪个文件需要全部输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># left outer join</span></span><br><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> <span class="operator">-a</span> <span class="number">1</span> user_list.sorted.tsv record.sorted.tsv | wc <span class="operator">-l</span></span><br></pre></td></tr></table></figure>
<pre><code>6718272
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> <span class="operator">-a</span> <span class="number">1</span> user_list.sorted.tsv record.sorted.tsv | head</span><br></pre></td></tr></table></figure>
<pre><code><span class="number">10</span>    <span class="number">10</span>    ＭｏＭｏ.
<span class="number">100</span>    <span class="number">100</span>    Jacob
<span class="number">10000</span>    <span class="number">10000</span>    漠漠
<span class="number">100000</span>    <span class="number">100000</span>    natalie_1204
<span class="number">100001</span>    <span class="number">100001</span>    七堂伽蓝
<span class="number">100002</span>    <span class="number">100002</span>    宇
<span class="number">100003</span>    <span class="number">100003</span>    二的二次方
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">10380</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">09</span>-<span class="number">30</span>    <span class="number">10</span>    标签:;中二病;花泽香菜;嘟嘟噜;牧瀬紅莉栖;Steins
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">10440</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>    <span class="number">9</span>    标签:;あの日見た花の名前を僕達はまだ知らない
<span class="number">100004</span>    <span class="number">100004</span>    从不卖萌的K    <span class="number">10639</span>    anime    <span class="keyword">collect</span>    <span class="number">2012</span>-<span class="number">10</span>-<span class="number">02</span>        标签:;虚渊玄;奈绪蘑菇;梶浦
<span class="keyword">join</span>: <span class="keyword">write</span> error: Broken pipe
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># right outer join</span></span><br><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> <span class="operator">-a</span> <span class="number">2</span> user_list.sorted.tsv record.sorted.tsv | wc <span class="operator">-l</span></span><br></pre></td></tr></table></figure>
<pre><code>6492074
</code></pre><p>这里我们可以看到使用 RIGHT OUTER JOIN 的时候，对于没有被 join 上的用户就是在 user_list 中没有出现的用户。这时候没有被 join 上用户名和用户昵称的记录应该和 user_failure.tsv 的内容是一样的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> <span class="operator">-a</span> <span class="number">2</span> user_list.sorted.tsv record.sorted.tsv | sort &gt; record.complete.tsv</span><br><span class="line">join -t$<span class="string">'\t'</span> -<span class="number">1</span> <span class="number">2</span> -<span class="number">2</span> <span class="number">1</span> user_list.sorted.tsv record.sorted.tsv | sort &gt; record.inner.tsv</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">comm -<span class="number">13</span> record.inner.tsv record.complete.tsv| cut <span class="operator">-f</span>1 | uniq | diff - user_failure.tsv</span><br></pre></td></tr></table></figure>
<pre><code><span class="keyword">140d139</span>
<span class="tag">&lt; sdf4
141a141
&gt;</span> <span class="keyword">sdf4</span>
</code></pre><p>可以看到两个文件在实际内容上，除了顺序有所差别，并没有本质上的变动。这一定程度上证明了 JOIN 的正确性。</p>
<p>当然，我们既然有了 <code>join</code>，就会有人问怎么进行多个 column 的 join？遗憾的是，目前 <code>join</code> 只支持一列的 join。对于多列的 join 可以参考<a href="http://stackoverflow.com/a/26370525" target="_blank" rel="external">这个</a>。</p>
<h2 id="5-_Conclusion_and_future_plan_for_Bangumi_Spider">5. Conclusion and future plan for Bangumi Spider</h2><p>依据现有的技术，我们可以通过配合 <code>awk</code> 与 <code>sort</code> 进行文本文件操作从而组合成各种我们想要的类似于 SQL 语句的功能，这个给我们线下调试带来了很大的方便。同时我们可以使用 <code>cat</code>、<code>comm</code> 达到交集、并集和差集的功能，使用 <code>join</code> 可以把两个文件通过指定的列 join 起来。在懒得使用 pandas 或数据库的时候，这些命令给我们带来了很大的方便。</p>
<p>同时，我觉得目前 Bangumi Spider 问题太多。我计划从一下方面入手将 Bangumi Spider 升级：</p>
<ol>
<li>废除 user spider，更新 record spider 使之记录 user spider 目前所记录的所有信息，在爬虫结束任务之后，通过 raw record spider 生成 record 记录和 user 记录。后期处理还要力求 record spider 不能重复爬取条目。</li>
<li>修改 Bangumi Spider 对 Bangumi 主站 500 错误的处理。</li>
<li>保留 subject spider 的部分功能，特别是 infobox 那边的功能，去掉 tag 信息。 subject 要和 record 相 join 解决条目重定位的问题。</li>
</ol>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
        

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2017/03/18/机器学习的疯狂三月——NCAA-男篮预测竞赛/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        

        
    <!-- JiaThis Button BEGIN -->
    <div class="jiathis_style_24x24">
        <a class="jiathis_button_weixin"></a>
        <a class="jiathis_button_tsina"></a>
        <a class="jiathis_button_twitter"></a>
        <a class="jiathis_button_fb"></a>
        <a class="jiathis_button_googleplus"></a>
        <a class="jiathis_button_linkedin"></a>
        <a class="jiathis_button_copy"></a>
        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
        <a class="jiathis_counter_style"></a>
    </div>
    <script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
    <!-- JiaThis Button END -->
    <br>


    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>

  
  	 <div id="disqus_thread">
     <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  	 </div>
  
</section>

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-04-14 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Notes/">Notes<span>7</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/coreutils/">coreutils<span>1</span></a></li> <li><a href="/tags/linux/">linux<span>1</span></a></li> <li><a href="/tags/tools/">tools<span>2</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'wattlebirdgithubio';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 Ronnie Wang
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
   </html>
